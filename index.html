<!DOCTYPE html>
<html>
    <head>
        <!-- Meta -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Riichi Centrepiece</title>



        <!-- CSS -->
        <style>
            /* Responsive font and global styles */
            :root {
                --red: #ff5555;
                --green: #55dd55;
                --blue: #5555ff;
                --grey: #AAAAAA;

                --text-dark: #e8e6e3;
                --bg-dark: #181a1b;

                --text-light: #333333;
                --bg-light: #FFF7F1;

                --text: var(--text-light);
                --bg: var(--bg-light);

            }

            * {
                font-family: "Hiragino Mincho", "AoyagiKouzanFont2OTF", "EPSON 太行書体Ｂ", "Times New Roman", serif; 
                font-size: 10vmin;
                background-color: var(--bg);
                color: var(--text);
            }


            html, body {
                height: 100%;
            }

            html {
                display: table;
                margin: auto;
            }

            body {
                display: table-cell;
                vertical-align: middle;
            }

            p {
                -webkit-user-select: none; /* Safari */
                -ms-user-select: none; /* IE 10 and IE 11 */
                user-select: none; /* Standard syntax */
            }
            
            /* Multi-language support */
            [data-user-lang=en] [lang]:not([lang=en]),
            [data-user-lang=jp] [lang]:not([lang=jp]) {
                display: none;
            }


            /* Layout information */
            .container {
                display: grid;
                grid-template-areas:
                    "darkmode  top    playercount"
                    "left      naka   right"
                    "gametype bottom languageswitch";
                grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr);
                grid-template-rows: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr);
            }

            #darkmode {
                grid-area: darkmode;
            }

            #playercount {
                grid-area: playercount;
            }

            #gametype {
                grid-area: gametype;
            }

            #languageswitch {
                grid-area: languageswitch;
            }

            .container > .bottom {
                grid-area: bottom;
                transform: rotate(0deg);
            }
            .container > .right {
                grid-area: right;
                transform: rotate(270deg);
            }
            .container > .top {
                grid-area: top;
                transform: rotate(180deg);
            }
            .container > .left {
                grid-area: left;
                transform: rotate(90deg);
            }

            .container > #naka {
                grid-area: naka;
            }

            .seat {
                justify-self: center;
                align-self: center;
                width: 20vmin;
                height: 20vmin;
            }

            .seat p {
                font-weight: bold;
                font-size: 20vmin;
                margin: 0;
                text-align: center;
            }

            .hidden {
                visibility: hidden;
            }

            #naka {
                justify-self: center;
                align-self: center;
                text-align: center;
            }

            #tonNakaDisplay {
                display: none;
            }

            #nanNakaDisplay {
                display: none;
            }

            #shaaNakaDisplay {
                display: none;
            }

            #peiNakaDisplay {
                display: none;
            }

            #roundinfo {
                margin: 0;
                font-weight: bold;
                font-size: 0;
            }

            .nakaDisplay {
                font-size: 0;
            }

            .nakaDisplay span {
                font-size: 10vmin;
                color: var(--blue);
            }

            #honbainfo {
                margin: 0;
                font-size: 0;
            }

            #honbainfo span {
                font-size: 8vmin;
            }

            #honbacount {
                margin: 0;
                font-size: 8vmin;
            }

            #ton p {
                color: var(--red);
            }

            .option, .option span, .option path {
                color: var(--grey);

                border-width: 0;
                font-size: 6vmin;
            }

            .selected {
                color: var(--green) !important; /* FIXME */
                font-weight: bold !important; /* FIXME */
            }
        </style>
    </head>

    <body data-user-lang="jp">
        <!-- HTML -->
        <div class="container">
            <!-- Seats -->
            <div id="ton" class="seat">
                <p class="seatwind" lang="jp">東</p>
                <p class="seatwind" lang="en">E</p>
            </div>

            <div id="nan" class="seat">
                <p class="seatwind" lang="jp">南</p>
                <p class="seatwind" lang="en">S</p>
            </div>

            <div id="shaa" class="seat">
                <p class="seatwind" lang="jp">西</p>
                <p class="seatwind" lang="en">W</p>
            </div>

            <div id="pei" class="seat">
                <p class="seatwind" lang="jp">北</p>
                <p class="seatwind" lang="en">N</p>
            </div>


            <!-- Information -->
            <div id="naka">
                <p id="roundinfo">
                    <span id="roundwind">
                        <span id="tonNakaDisplay" class="nakaDisplay">
                            <span lang="jp">東</span>
                            <span lang="en">E</span>
                        </span>
                        <span id="nanNakaDisplay" class="nakaDisplay">
                            <span lang="jp">南</span>
                            <span lang="en">S</span>
                        </span>
                        <span id="shaaNakaDisplay" class="nakaDisplay">
                            <span lang="jp">西</span>
                            <span lang="en">W</span>
                        </span>
                        <span id="peiNakaDisplay" class="nakaDisplay">
                            <span lang="jp">北</span>
                            <span lang="en">N</span>
                        </span>
                    </span>
                    <span id="roundcount"></span>

                    <span lang="jp">局</span>
                    <span lang="en"></span>
                </p>

                <p id="honbainfo"> 
                    <span id="honbacount"></span>
                    <span lang="jp">本場</span>
                    <span lang="en">H</span>
                </p>
                
            </div>

            <!-- Options -->
            <button id="darkmode" class="option"></button>

            <button id="languageswitch" class="option">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-globe" viewBox="0 0 16 16">
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m7.5-6.923c-.67.204-1.335.82-1.887 1.855A8 8 0 0 0 5.145 4H7.5zM4.09 4a9.3 9.3 0 0 1 .64-1.539 7 7 0 0 1 .597-.933A7.03 7.03 0 0 0 2.255 4zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a7 7 0 0 0-.656 2.5zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5zM8.5 5v2.5h2.99a12.5 12.5 0 0 0-.337-2.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5zM5.145 12q.208.58.468 1.068c.552 1.035 1.218 1.65 1.887 1.855V12zm.182 2.472a7 7 0 0 1-.597-.933A9.3 9.3 0 0 1 4.09 12H2.255a7 7 0 0 0 3.072 2.472M3.82 11a13.7 13.7 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5zm6.853 3.472A7 7 0 0 0 13.745 12H11.91a9.3 9.3 0 0 1-.64 1.539 7 7 0 0 1-.597.933M8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855q.26-.487.468-1.068zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.7 13.7 0 0 1-.312 2.5m2.802-3.5a7 7 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7 7 0 0 0-3.072-2.472c.218.284.418.598.597.933M10.855 4a8 8 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4z"/>
                </svg>
            </button>

            <button id="playercount" class="option"></button>

            <button id="gametype" class="option"></button>
        </div>

        <!-- Javascript -->
        <script>
            // Constants

            const WIND_TON        = 0;
            const WIND_NAN        = 1;
            const WIND_SHAA       = 2;
            const WIND_PEI        = 3;

            const POSITIONS       = ["bottom", "right", "top", "left"];   // CSS classes

            const PLAYER_DEFAULT  = 4;
            const PLAYER_SANMA    = 3;

            const ROUND_TONPUUSEN = 1;
            const ROUND_HANCHAN   = 2;
            const ROUND_IICHAN    = 4;


            // Element constants

            const ELEMENT_TON     = document.getElementById("ton");
            const ELEMENT_NAN     = document.getElementById("nan");
            const ELEMENT_SHAA    = document.getElementById("shaa");
            const ELEMENT_PEI     = document.getElementById("pei");

            const NAKA_TON        = document.getElementById("tonNakaDisplay");
            const NAKA_NAN        = document.getElementById("nanNakaDisplay");
            const NAKA_SHAA       = document.getElementById("shaaNakaDisplay");
            const NAKA_PEI        = document.getElementById("peiNakaDisplay");

            const WINDS           = [NAKA_TON, NAKA_NAN, NAKA_SHAA, NAKA_PEI];

            const WIND_DISPLAY    = document.getElementById("roundwind");

            const INFO_ROUND      = document.getElementById("roundinfo");
            const DISPLAY_ROUND   = document.getElementById("roundcount");

            const INFO_HONBA      = document.getElementById("honbainfo");
            const DISPLAY_HONBA   = document.getElementById("honbacount");

            const LANGUAGES       = ["jp", "en"];

            const BTN_DARKMODE    = document.getElementById("darkmode");
            const BTN_LANGUAGE    = document.getElementById("languageswitch");
            const BTN_PLAYERC     = document.getElementById("playercount");
            const BTN_GAMET       = document.getElementById("gametype");


            // State

            let darkMode = false;
            let language = "jp";
            let players = 4;
            let maxRounds = 2; 
            let wakeLock = null;    // Used for UI locking in window.onload

            let round = 1;
            let wind = WIND_TON;
            let honba = 0;
          
          

            // Utility functions

            function isStart() {
                return round === 1 && wind === WIND_TON && honba === 0;
            }

            function reset() {
                round = 1;
                wind = WIND_TON;
                honba = 0;

                updateDisplay();
            }

            
            // Display functions

            function updateDisplay() {
                // Seat positions
                let pos = POSITIONS.slice();        // Rotating a copy
                pos = pos.splice(0, players);       // Filter out by amount of players
                
                for (let i=0; i<round-1; i++)
                    pos.push(pos.splice(0, 1)[0]);

                pos.forEach(e => {                  // Remove all position from all elements
                    ELEMENT_TON.classList.remove(e);
                    ELEMENT_NAN.classList.remove(e);
                    ELEMENT_SHAA.classList.remove(e);
                    ELEMENT_PEI.classList.remove(e);
                });
                
                ELEMENT_TON.classList.add(pos[0]);  // Apply them to each seat _ELEMENT
                ELEMENT_NAN.classList.add(pos[1]);
                ELEMENT_SHAA.classList.add(pos[2]);

                if (players === PLAYER_DEFAULT) {   // Only apply PEI if 4 players are active
                    ELEMENT_PEI.classList.add(pos[3]);
                    ELEMENT_PEI.classList.remove("hidden");
                } else {                            // Otherwise hide the PEI seat
                    ELEMENT_PEI.classList.add("hidden");
                }
                

                // Naka 
                WINDS.forEach(e => e.style.display = "none");
                WINDS[wind].style.display = "initial";
                DISPLAY_ROUND.innerText = `${round}`;
                DISPLAY_HONBA.innerText = `${honba}`;


                // Options
                if (darkMode)           // Dark mode button
                    BTN_DARKMODE.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-sun" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6m0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"/></svg>`;
                else 
                    BTN_DARKMODE.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/></svg>`;


                if (isStart())          // Player count button
                    if (players == PLAYER_DEFAULT)
                        BTN_PLAYERC.innerHTML = `3<span class="selected">4</span>`; 
                    else 
                        BTN_PLAYERC.innerHTML = `<span class="selected">3</span>4`;
                else 
                    BTN_PLAYERC.innerHTML = `&#10227;`;


                if (isStart())          // Gametype button
                    if (maxRounds === ROUND_TONPUUSEN) 
                        BTN_GAMET.innerHTML = `
                            <span lang="jp"><span class="selected">東</span>半一</span>
                            <span lang="en"><span class="selected">T</span>HI</span>
                            `;
                    else if (maxRounds === ROUND_HANCHAN)
                        BTN_GAMET.innerHTML = `
                            <span lang="jp">東<span class="selected">半</span>一</span>
                            <span lang="en">T<span class="selected">H</span>I</span>
                        `;
                    else
                        BTN_GAMET.innerHTML = `
                            <span lang="jp">東半<span class="selected">一</span></span>
                            <span lang="en">TH<span class="selected">I</span></span>
                        `;
                else 
                    BTN_GAMET.innerHTML = `&#10227;`;
            }


            function toggleDarkMode() {
                darkMode = !darkMode;               // Toggle bool

                // Change CSS variables
                const root = document.querySelector(":root");
                const style = root.style;
                const comp_style = window.getComputedStyle(root);

                let new_bg;
                let new_text;

                if (darkMode) { 
                    new_bg = comp_style.getPropertyValue("--bg-dark");
                    new_text = comp_style.getPropertyValue("--text-dark");
                } else {
                    new_bg = comp_style.getPropertyValue("--bg-light");
                    new_text = comp_style.getPropertyValue("--text-light");
                }

                style.setProperty("--bg", new_bg);
                style.setProperty("--text", new_text);


                // Refresh screen
                updateDisplay();
            }


            function toggleLanguage() {
                const i = LANGUAGES.indexOf(language);
                const next_lang = LANGUAGES[(i+1) % LANGUAGES.length];

                language = next_lang;
                document.body.setAttribute("data-user-lang", language);
            }



            // Round control functions

            function nextWind() {
                wind = (wind + 1) % maxRounds;      // Capping value to setting


                // Reset state (round and honba)
                round = 1;
                honba = 0;
                // Call from nextRound should update display 
            }


            function nextRound() {
                if (round === players)                  // Check if next wind
                    nextWind();
                else {
                    honba = 0;
                    round++;                            // Increment counter
                }

                updateDisplay();
            }


            function nextHonba() {
                honba++;                                // Increment counter
                updateDisplay();
            }
            

            function togglePlayerCount() {
                if (players === PLAYER_DEFAULT) 
                    players = PLAYER_SANMA;
                else
                    players = PLAYER_DEFAULT;

                updateDisplay();
            }


            function toggleGameType() {
                if (maxRounds === ROUND_TONPUUSEN)
                    maxRounds = ROUND_HANCHAN;
                else if (maxRounds === ROUND_HANCHAN)
                    maxRounds = ROUND_IICHAN;
                else
                    maxRounds = ROUND_TONPUUSEN;

                updateDisplay();
            }





            // Mobile features

            async function noSleep() {
                try {
                    wakeLock = await navigator.wakeLock.request("screen");

                    // Attempt reblock if wakeLock is released
                    wakeLock.addEventListener("release", () => {
                        noSleep();
                    });
                } catch (err) {
                    console.log(`Caught ${err.name}, wakeLock will not be called. (${err.message})`);
                }
            }


            function toggleFullscreen() {
                if (document.fullscreenElement === null)
                    document.documentElement.requestFullscreen();
                else
                    document.exitFullscreen();
            }



            // Main

            window.onload = () => {
                // Resetting state and updating display for the first time
                reset();
                updateDisplay();
              
                // Reclaiming wake lock
                document.addEventListener("visibilitychange", async () => {
                    if (wakeLock !== null && document.visibilityState === "visible")
                        noSleep();
                });

                // Setting up wake lock
                if ("wakeLock" in navigator) {
                    noSleep();          // Starts async loop
                } else {
                    console.log(`wakeLock does not exist, wakeLock will not be called.`);
                }

                // Bindings
                INFO_ROUND.addEventListener("click", nextRound);
                DISPLAY_HONBA.addEventListener("click", nextHonba);

                ELEMENT_TON.addEventListener("dblclick", toggleFullscreen);
                ELEMENT_NAN.addEventListener("dblclick", toggleFullscreen);
                ELEMENT_SHAA.addEventListener("dblclick", toggleFullscreen);
                ELEMENT_PEI.addEventListener("dblclick", toggleFullscreen);

                BTN_DARKMODE.addEventListener("click", toggleDarkMode);
                BTN_LANGUAGE.addEventListener("click", toggleLanguage);

                BTN_PLAYERC.addEventListener("click", () => {
                    if (isStart())
                        togglePlayerCount();
                    else
                        reset();
                });

                BTN_GAMET.addEventListener("click", () => {
                    if (isStart())
                        toggleGameType();
                    else
                        reset();
                });
            }
        </script>
        <noscript>  <!-- Hiding the entire page if no script is active -->
            <style> .container {display: none} </style>
            <span>Please enable JavaScript</span>
        </noscript>
    </body>
</html>
